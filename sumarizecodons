#!/bin/bash
# by AndrÃ©s Culasso PhD
# This script scans for subfolders with multiple csv files generated by
# readposition script and produce 3 files.
#   main-codon.txt --> a text file with the name of the csv file, the 
#                      triplet and the % value of that triplet.
#   lecturas_por_posicion.csv --> a table with the name of the csv, the
#                                 total number of reads, and the number
#                                 of different triplets at that position
#   codon_summary.csv --> a table that could be easly exported to excel 
#                         sumarizing for each codon position the ammount
#						  and the identity of those triplets with more  
#						  than 1% of prevalence.
# this script is mostly hardcoded, it will scan for csv files in al sub-
# folders (1 level), following the default behabiour of readposititions script
for f in */*.csv
  do 
  awk '$3 >= 0.01 { print FILENAME, $1, $3 }' $f > main-codon.txt
  awk ' { cod++; tot=tot+$2 }; END { print FILENAME, tot, cod }' $f > lecturas_por_posicion.csv
done
awk '{ a[$1]=a[$1] " " $2 " " $3 };END{PROCINFO["sorted_in"]="@ind_str_asc"; for (i in a){ print i,a[i]; }}' main-codon.txt > collapsed_main_codon.csv
join <(sort lecturas_por_posicion.csv) <(sort collapsed_main_codon.csv) -a 1 > codon_summary.csv
